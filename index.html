<script>
    // https://script.google.com/macros/s/AKfycbwxToUTfmbTa0tRDAeQ5rkksQAmPBv2gKyNl2HkUR_XsZ2ECwYrZB8OOPaWxNhYMfMWew/exec
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwxToUTfmbTa0tRDAeQ5rkksQAmPBv2gKyNl2HkUR_XsZ2ECwYrZB8OOPaWxNhYMfMWew/exec';
    
    // データを保存する配列（ローカル表示用）
    let inspectionData = [];

    // ページ読み込み時の初期化
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date').value = today;
        document.getElementById('startDate').value = today;
        document.getElementById('endDate').value = today;
        
        // スプレッドシートからデータを読み込み
        loadDataFromSpreadsheet();
    });

    // スプレッドシートにデータ保存
    async function saveToSpreadsheet(date, count) {
        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    date: date,
                    count: count
                })
            });
            console.log('スプレッドシートに保存しました');
            return true;
        } catch (error) {
            console.error('保存エラー:', error);
            return false;
        }
    }

    // スプレッドシートからデータ読み込み
    async function loadDataFromSpreadsheet() {
        try {
            const response = await fetch(SCRIPT_URL);
            const result = await response.json();
            
            if (result.success) {
                // データを変換
                inspectionData = result.data.map((row, index) => ({
                    id: index,
                    date: new Date(row[0]).toISOString().split('T')[0],
                    count: parseFloat(row[1])
                }));
                
                displayRecords();
            }
        } catch (error) {
            console.error('データ読み込みエラー:', error);
        }
    }

    // フォーム送信の処理
    document.getElementById('inspectionForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const date = document.getElementById('date').value;
        const count = parseFloat(document.getElementById('count').value);
        
        if (!date || isNaN(count) || count < 0) {
            alert('すべての項目を正しく入力してください。');
            return;
        }
        
        // スプレッドシートに保存
        const saved = await saveToSpreadsheet(date, count);
        
        if (saved) {
            // ローカルデータも更新
            const newRecord = {
                id: Date.now(),
                date: date,
                count: count
            };
            
            inspectionData.push(newRecord);
            document.getElementById('count').value = '';
            displayRecords();
            alert('データが保存されました！');
        } else {
            alert('保存に失敗しました。再度お試しください。');
        }
    });

    // データ一覧の表示
    function displayRecords() {
        const recordsList = document.getElementById('recordsList');
        
        if (inspectionData.length === 0) {
            recordsList.innerHTML = '<div class="no-data">まだデータが入力されていません</div>';
            return;
        }
        
        const sortedData = [...inspectionData].sort((a, b) => new Date(b.date) - new Date(a.date));
        
        let html = `
            <table class="records-table">
                <thead>
                    <tr>
                        <th>日付</th>
                        <th>検品完了数（1人あたり）</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        sortedData.forEach(record => {
            html += `
                <tr>
                    <td>${record.date}</td>
                    <td>${record.count}件</td>
                    <td><button class="delete-btn" onclick="deleteRecord(${record.id})">削除</button></td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        recordsList.innerHTML = html;
    }

    // データの削除
    function deleteRecord(id) {
        if (confirm('このデータを削除してもよろしいですか？')) {
            inspectionData = inspectionData.filter(record => record.id !== id);
            displayRecords();
        }
    }

    // 集計の計算（スプレッドシートから取得）
    async function calculateSummary() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        
        if (!startDate || !endDate) {
            alert('開始日と終了日を選択してください。');
            return;
        }
        
        if (new Date(startDate) > new Date(endDate)) {
            alert('開始日は終了日より前の日付を選択してください。');
            return;
        }
        
        try {
            const url = `${SCRIPT_URL}?startDate=${startDate}&endDate=${endDate}`;
            const response = await fetch(url);
            const result = await response.json();
            
            if (result.success && result.dataCount > 0) {
                let html = `
                    <div class="summary-card">
                        <h3>${Math.round(result.totalCount * 100) / 100}</h3>
                        <p>総検品完了数</p>
                    </div>
                    <div class="summary-card">
                        <h3>${result.dataCount}</h3>
                        <p>データ件数</p>
                    </div>
                    <div class="summary-card">
                        <h3>${result.average}</h3>
                        <p>1日あたり平均</p>
                    </div>
                `;
                
                document.getElementById('summaryResult').innerHTML = html;
            } else {
                document.getElementById('summaryResult').innerHTML = '<div class="no-data">選択した期間にデータがありません</div>';
            }
        } catch (error) {
            console.error('集計エラー:', error);
            alert('集計データの取得に失敗しました。');
        }
    }
</script>
